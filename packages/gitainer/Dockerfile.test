FROM docker:27.1.2-dind

# Install dependencies (git for tests, bash for scripts)
RUN apk add --no-cache git bash npm diffutils ca-certificates wget musl-dev make gcompat curl

# Install Bun via npm
RUN npm install -g bun

WORKDIR /app

# Copy dependency definitions
COPY bun.lockb packages/gitainer/package.json ./
RUN bun install

# Copy source
COPY packages/gitainer/ .

# Use custom entrypoint
COPY packages/gitainer/test-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/test-entrypoint.sh

ENTRYPOINT ["test-entrypoint.sh"]
CMD ["bun", "test"]
